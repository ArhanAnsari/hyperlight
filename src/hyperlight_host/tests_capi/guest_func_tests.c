#include "hyperlight_host.h"
#include "munit/munit.h"
#include "val_ref.h"
#include "callback.h"
#include "guest_func_tests.h"
#include "err.h"
#include "stdio.h"

MunitResult test_write_guest_function_call()
{

    Context *ctx = context_new();
    size_t code_size = 4096;
    size_t stack_size = 4096;
    size_t heap_size = 4096;

    SandboxMemoryConfiguration mem_cfg = {
        .guest_error_buffer_size = 4096,
        .host_function_definition_size = 4096,
        .input_data_size = 4096,
        .output_data_size = 4096,
        .host_exception_size = 4096};

    Handle mem_layout_ref = mem_layout_new(ctx, mem_cfg, code_size, stack_size, heap_size);
    handle_assert_no_error(ctx, mem_layout_ref);
    long guest_mem_size = mem_layout_get_memory_size(ctx, mem_layout_ref);
    Handle shared_mem_ref = shared_memory_new(ctx, guest_mem_size);
    handle_assert_no_error(ctx, shared_mem_ref);
    Handle mem_mgr_ref = mem_mgr_new(
        ctx,
        mem_cfg,
        shared_mem_ref,
        mem_layout_ref,
        true,
        100,
        guest_mem_size);
    handle_assert_no_error(ctx, mem_mgr_ref);
    uintptr_t address = shared_memory_get_address(ctx, shared_mem_ref);
    Handle offset_ref = mem_mgr_get_address_offset(ctx, mem_mgr_ref, address);
    handle_assert_no_error(ctx, offset_ref);
    uint64_t offset = handle_get_uint_64(ctx, offset_ref);
    Handle write_layout_result = mem_layout_write_memory_layout(ctx, mem_layout_ref, shared_mem_ref, address - offset, guest_mem_size);
    handle_assert_no_error(ctx, write_layout_result);

    // valid buffer

    unsigned char buffer[400] = {0x2c, 0x01, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x00, 0x0c, 0x00, 0x04, 0x00, 0x08, 0x00, 0x08, 0x00, 0x00, 0x00, 0x04, 0x01, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x07, 0x00, 0x00, 0x00, 0xd0, 0x00, 0x00, 0x00, 0xb0, 0x00, 0x00, 0x00, 0x84, 0x00, 0x00, 0x00, 0x60, 0x00, 0x00, 0x00, 0x3c, 0x00, 0x00, 0x00, 0x24, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x54, 0xff, 0xff, 0xff,
                                 0x00, 0x00, 0x00, 0x04, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x00, 0x08, 0x00, 0x07, 0x00, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x8c, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x04, 0x08, 0x00, 0x00, 0x00, 0x04, 0x00, 0x04, 0x00, 0x04, 0x00, 0x00, 0x00, 0xa0, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x03, 0x04, 0x00, 0x00, 0x00, 0x7a, 0xff, 0xff, 0xff, 0x04, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00,
                                 0x54, 0x65, 0x73, 0x74, 0x37, 0x00, 0x00, 0x00, 0xc0, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x03, 0x04, 0x00, 0x00, 0x00, 0x9a, 0xff, 0xff, 0xff, 0x04, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x54, 0x65, 0x73, 0x74, 0x65, 0x64, 0x00, 0x00, 0xc4, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x02, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x00, 0x0c, 0x00, 0x04, 0x00, 0x06, 0x00, 0x00, 0x00, 0x09, 0x00, 0x00, 0x00,
                                 0x00, 0x00, 0x00, 0x00, 0x08, 0x00, 0x0c, 0x00, 0x07, 0x00, 0x08, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x04, 0x00, 0x00, 0x00, 0xe2, 0xff, 0xff, 0xff, 0x08, 0x00, 0x00, 0x00, 0x08, 0x00, 0x0e, 0x00, 0x07, 0x00, 0x08, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x00, 0x08, 0x00, 0x04, 0x00, 0x06, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00,
                                 0x05, 0x00, 0x00, 0x00, 0x54, 0x65, 0x73, 0x74, 0x37, 0x00, 0x00, 0x00, 0x0e, 0x00, 0x00, 0x00, 0x50, 0x72, 0x69, 0x6e, 0x74, 0x53, 0x65, 0x76, 0x65, 0x6e, 0x41, 0x72, 0x67, 0x73, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                                 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};

    Handle result = mem_mgr_write_guest_function_call(ctx,
                                                      mem_mgr_ref,
                                                      buffer);

    handle_assert_no_error(ctx, result);
    handle_free(ctx, result);

    // invalid buffer

    unsigned char invalid_buffer[400] = {0x2c, 0x01, 0x00, 0x00, 0x10, 0x00};

    result = mem_mgr_write_guest_function_call(ctx,
                                               mem_mgr_ref,
                                               invalid_buffer);

    handle_assert_error(ctx, result);
    handle_free(ctx, result);

    // null_ptr

    unsigned char *null_ptr = 0;

    result = mem_mgr_write_guest_function_call(ctx,
                                               mem_mgr_ref,
                                               null_ptr);

    handle_assert_error(ctx, result);
    handle_free(ctx, result);

    handle_free(ctx, write_layout_result);
    handle_free(ctx, offset_ref);
    handle_free(ctx, mem_layout_ref);
    handle_free(ctx, mem_mgr_ref);
    handle_free(ctx, shared_mem_ref);
    context_free(ctx);
    return MUNIT_OK;
}
