# yaml-language-server: $schema=https://json.schemastore.org/github-action.json

name: 'Hyperlight Workflow Setup'
description: 'Common setup steps for GitHub workflows in the Hyperlight project'

runs:
  using: composite
  steps:
    - uses: dtolnay/rust-toolchain@1.74.0
      with:
        components: clippy, rustfmt
    - uses: extractions/setup-just@v1
      with:
        just-version: '1.15.0' # optional semver specification, otherwise latest

    ###
    ### Linux setup
    ###
    - name: Cargo login
      if: ${{ (runner.os == 'Linux') }}  
      run: just cargo-login-ci
      shell: bash


    ###
    ### Windows setup
    ###
    - name: Cargo login
      if: ${{ (runner.os == 'Windows') }}
      run: just cargo-login-ci-windows
      shell: pwsh

    # Install clang-tools on Linux

    - name: Install clang-tools (Linux mariner)
      if: ${{ (runner.os == 'Linux' && matrix.hypervisor == 'hyperv') }}
      run: |
        sudo dnf remove clang -y|| true
        sudo dnf install clang16 -y
        sudo dnf install clang16-tools-extra -y
      shell: bash

    - name: Install clang-tools (Linux ubuntu)
      if: ${{ (runner.os == 'Linux' && matrix.hypervisor == 'kvm') }}
      run: |
        wget https://apt.llvm.org/llvm.sh 
        chmod +x ./llvm.sh
        sudo ./llvm.sh 16 all
        sudo ln -s /usr/lib/llvm-16/bin/clang-cl /usr/bin/clang-cl
        sudo ln -s /usr/lib/llvm-16/bin/llvm-lib /usr/bin/llvm-lib
      shell: bash